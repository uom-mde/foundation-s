<div class="list-of-sites">
    <?php
    // Get the helper
    $siteSettingService = $this->getHelperPluginManager()->get('siteSetting');

    // Group arrays
    $librarySites = [];

    // Categorize sites
    foreach ($sites as $site) {
        $category = $siteSettingService('extended_site_description_categories', null, $site->id());

        if (empty($category)) continue;

        if (is_array($category)) {
            if (in_array('Library', $category)) $librarySites[] = $site;
        }
    }

    // Function to render styled site cards
    function renderLibrarySiteGroup($groupTitle, $groupSites, $thumbnails, $summaries, $view) {
        if (empty($groupSites)) return;
    ?>

    <h2 class="site-group-heading"><?php echo htmlspecialchars($groupTitle); ?></h2>
    <div class="site-list layout-card">
        <?php foreach ($groupSites as $site) {
                $thumbnail = $thumbnails ? $site->thumbnail() : null;
                $summary = $summaries ? $site->summary() : null;
                ?>
                <div class="site card">
                    <?php if ($thumbnail): ?>
                        <div class="site-thumbnail">
                            <?php echo $view->thumbnail($thumbnail, 'square', ['class' => 'site-thumbnail-image']); ?>
                        </div>
                    <?php endif; ?>

                    <div class="card-divider">
                        <?php echo $view->hyperlink($site->title(), $site->siteUrl(), ['class' => 'site-link']); ?>
                    </div>

                    <?php if ($summary): ?>
                        <div class="site-summary card-section">
                            <?php echo nl2br($view->escapeHtml($summary)); ?>
                        </div>
                    <?php endif; ?>
                </div>
                <?php
            }
        }

        // Output both groups
        renderLibrarySiteGroup('Library Sites', $librarySites, $thumbnails, $summaries, $this);
        ?>
    </div>

    <?php if ($pagination): ?>
        <?php echo $this->pagination(); ?>
    <?php endif; ?>
</div>
