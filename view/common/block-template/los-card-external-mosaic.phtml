<div class="full-width">    
    <div class="grid-container reveal-on-scroll lazy-fade-in padding-top-1">  <!-- Load Effect block -->
        <h2 class="subheader site-group-heading margin-vertical-1">Research Exhibitions</h2>
        <div class="list-of-sites list-of-sites-mosaic">
            <?php
            // Get the helper
            $siteSettingService = $this->getHelperPluginManager()->get('siteSetting');

            // Group arrays
            $externalSites = [];

            // Categorize sites
            foreach ($sites as $site) {
                $featured = $siteSettingService('extended_site_description_featured', null, $site->id());
                $category = $siteSettingService('extended_site_description_categories', null, $site->id());
            
                if (empty($category) || !is_array($category)) continue;

                // Add site only if it has 'External' in category and NOT featured'
                if (in_array('External', $category) && !$featured) {
                    $externalSites[] = $site;
                }
                $externalCount = count($externalSites);
            }

            // Function to render styled site cards
            function renderExternalSiteGroup($groupTitle, $groupSites, $thumbnails, $summaries, $view, $siteCount) {
                if (empty($groupSites)) return;
            ?>

            <?php  
            $displaySites = array_slice($groupSites, 0, 6); 

            echo '<div class="site-list layout-card site-count-' . $siteCount . '">';?>
                <?php foreach ($displaySites as $site) {
                    $thumbnail = $thumbnails ? $site->thumbnail() : null;
                    $summary = $summaries ? $site->summary() : null;
                    ?>
                        <div class="site card">
                            <?php if ($thumbnail): ?>
                                <div class="site-thumbnail">
                                    <?php echo $view->thumbnail($thumbnail, 'square', ['class' => 'site-thumbnail-image']); ?>
                                </div>
                            <?php endif; ?>

                            <div class="card-divider">
                                <?php echo $view->hyperlink($site->title(), $site->siteUrl(), ['class' => 'site-link']); ?>
                            </div>

                            <?php if ($summary): ?>
                                <div class="site-summary card-section">
                                    <?php echo nl2br($view->escapeHtml($summary)); ?>
                                </div>
                            <?php endif; ?>
                        </div>
                    <?php
                    }
                }

                if (count($externalSites) > 6): ?>

                <?php endif; ?>


                <?php
                // Output both groups
                renderExternalSiteGroup('External Sites', $externalSites, $thumbnails, $summaries, $this, $externalCount);
                ?>
            <?php echo '</div>'; ?>

            <div class="view-all-link">
                <a href="<?php echo $this->url('site/page', [
                    'site-slug' => 'home',
                    'page-slug' => 'browse'
                ]); ?>#los-research-browse" class="button warning margin-vertical-1">
                    View All Research Sites
                </a>
            </div>

            <?php if ($pagination): ?>
                <?php echo $this->pagination(); ?>
            <?php endif; ?>
        </div>
    </div>
</div>