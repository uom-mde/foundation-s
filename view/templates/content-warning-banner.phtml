<?php
function showContentBanner($site, $currentLocale) {
    // Validate and sanitize slug (using FILTER_SANITIZE_STRING alternative for PHP 8.1+)
    $getSiteSlug = filter_var($site->slug(), FILTER_UNSAFE_RAW, FILTER_FLAG_STRIP_LOW | FILTER_FLAG_STRIP_HIGH);

    // Define allowed slugs
    $allowedSlugs = ['corala', 'corala-es', 'block-testing'];

    // Check if the current slug is in the allowed list
    if (in_array($getSiteSlug, $allowedSlugs, true)) {
        // Cookie name for page visits
        $cookieName = 'page_visits_' . $getSiteSlug;

        // Get the current visit count from the cookie (default to 0)
        $visitCount = isset($_COOKIE[$cookieName]) ? (int) $_COOKIE[$cookieName] : 0;

        // Increment the counter
        $visitCount++;

        // Set the updated cookie value with a 30-day expiration
        setcookie($cookieName, $visitCount, time() + (7 * 24 * 60 * 60), '/', '', false, true);

        // Check if the banner should still be displayed (first two visits)
        if ($visitCount <= 2) {
            // Use a mapping array for content warnings to avoid repetition
            $warnings = [
                'corala-es' => [
                    'message' => 'Aviso: Este sitio contiene material que puede resultar ofensivo.',
                    'link' => '/s/corala-es/page/advertencia_sobre_el_contenido',
                    'policy_text' => 'Lea nuestra declaración completa sobre el contenido.'
                ],
                'corala' => [
                    'message' => 'This exhibition contains material that some viewers may find offensive and/or distressing.',
                    'link' => '/s/corala/page/content_warning',
                    'policy_text' => 'Please read our full statement on the content.'
                ],
                'default-es' => [
                    'message' => 'Advertencia de contenido: este sitio contiene material que puede resultarle molesto.',
                    'link' => '#',
                    'policy_text' => 'Consulte nuestra política sobre material sensible'
                ],
                'default-en' => [
                    'message' => 'Content Warning: This site contains material you may find offensive.',
                    'link' => '#',
                    'policy_text' => 'View our policy on sensitive material'
                ]
            ];

            // Determine which warning to use
            $warning = $warnings[$getSiteSlug] ?? ($currentLocale === 'es' ? $warnings['default-es'] : $warnings['default-en']);

            // Output the banner with proper escaping to prevent XSS
            echo '<script>';
            echo 'console.log("This script runs only during the first two visits.");';
            echo 'var defaultBar = new $.peekABar({';
            echo '    html: "<div class=\"warning-bar\">" +';
            echo '              "<div class=\"warning-content\">" +';
            echo '              "<p class=\"lead\">' . htmlspecialchars($warning['message'], ENT_QUOTES, 'UTF-8') . ' " +'; 
            echo '              "<a href=\"' . htmlspecialchars($warning['link'], ENT_QUOTES, 'UTF-8') . '\">' . htmlspecialchars($warning['policy_text'], ENT_QUOTES, 'UTF-8') . '</a>" +'; 
            echo '              "</div>" +';
            echo '          "</div>"';
            echo '});';
            echo 'defaultBar.show();';
            echo '</script>';
        }
    }
}
?>