<?php
$translate = $this->plugin('translate');
$escape = $this->plugin('escapeHtml');
$this->headLink()->appendStylesheet($this->assetUrl('css/resource-page-blocks.css', 'Omeka'));
$this->htmlElement('body')->appendAttribute('class', 'item resource show');
$embedMedia = $this->siteSetting('item_media_embed', false);
$itemMedia = $item->media();
$showLayout = $this->themeSetting('show_layout');
$mediaDisplay = $this->themeSetting('media_display');
$this->headLink()->appendStylesheet($this->assetUrl('css/resource-page-blocks.css', 'Omeka'));

$fullWidthMainBlockContent = $this->resourcePageBlocks($item, 'full_width_main');
$fullWidthMainHasBlocks = $fullWidthMainBlockContent->hasBlocks();
$mainWithSidebarBlockContent = $this->resourcePageBlocks($item);
$mainWithSidebarHasBlocks= $mainWithSidebarBlockContent->hasBlocks();
$leftSidebarBlockContent = $this->resourcePageBlocks($item, 'left');
$leftSidebarHasBlocks = $leftSidebarBlockContent->hasBlocks();
$rightSidebarBlockContent = $this->resourcePageBlocks($item, 'right');
$rightSidebarHasBlocks = $rightSidebarBlockContent->hasBlocks();

$filterLocale = (bool) $this->siteSetting('filter_locale_values');
$lang = $this->lang();
$valueLang = $filterLocale ? [$lang, ''] : null;

// Debugging output to inspect viewers
//echo "<pre>";
// print_r($viewers);
// echo "</pre>";
?>

<div class="<?php echo ($showLayout == 'inline') ? 'inline' : 'stack'; ?>">
    <?php $this->trigger('view.show.before'); ?>
    <?php if ($fullWidthMainHasBlocks): ?>
        <?php 
        $viewers = [];
        $youtubeViewer = null;
        $defaultViewer = null;
        $firstMedia = true; // Ensure this is defined
        
        foreach ($itemMedia as $index => $media) {
            $mediaType = $media->mediaType();
            $mediaRenderer = $media->renderer();
        
            // Debugging output
            // echo "Index: $index, Media Renderer: $mediaRenderer, Media Type: $mediaType<br>";
        
            if ($firstMedia) {
                if ($mediaRenderer == 'youtube') {
                    $viewers[] = 'youtube';
                    $youtubeViewer = "<div class='responsive-embed widescreen'>" . $media->render() . "</div>";
                    $firstMedia = false;
                } else {
                    $viewers[] = 'default';
                    $defaultViewer = $media->render();
                    $firstMedia = false;
                }
            } 
            // else {
                // Optional logic for additional media
                //echo "Additional media detected at index $index.<br>";
            //}
        }
        ?>
    <div class="<?php echo ($showLayout == 'inline') ? 'inline' : 'stack'; ?>">
        <div class="full-width grid-x grid-padding-x">
            <?php $this->trigger('view.show.before'); ?>
            <div class="main-with-sidebar cell medium-8 margin-bottom-2 xlarge-margin-bottom-3">
                <?php 
                // Display the main viewer
                if ($youtubeViewer !== null) {
                    echo $youtubeViewer;
                } 
                elseif ($defaultViewer !== null) {
                    echo $defaultViewer;
                }
                ?>
            </div>
            <div class="right-sidebar cell medium-4 medium-padding-vertical-1 xlarge-padding-horizontal-2">
                <div class="resource-title">
                    <?php echo $this->pageTitle($item->displayTitle(null, $valueLang), 2); ?>
                    <h2 class="label"><?php echo $translate('Item'); ?></h2>
                </div>
                <?php echo $fullWidthMainBlockContent->getBlocks(); ?>
            </div>
        </div>
    </div>
    <?php endif; ?>

    <?php if ($mainWithSidebarHasBlocks || $leftSidebarHasBlocks || $rightSidebarHasBlocks): ?>
    <?php 
    if ($leftSidebarHasBlocks && $rightSidebarHasBlocks) {
        $sidebarWidth = '3';
        $mainWidth = '6';
    } else {
        $sidebarWidth = '4';
        $mainWidth = '8';
    }
    ?>
    
    <div class="grid-x grid-margin-x full-width">
        <?php if ($leftSidebarHasBlocks): ?>
        <div class="left-sidebar cell medium-<?php echo $sidebarWidth; ?>">
            <?php echo $leftSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>

        <?php if ($mainWithSidebarHasBlocks): ?>
        <div class="main-with-sidebar cell medium-<?php echo $mainWidth; ?>">
            <?php echo $mainWithSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>

        <?php if ($rightSidebarHasBlocks): ?>
        <div class="right-sidebar cell medium-<?php echo $sidebarWidth; ?> large-padding-1 xlarge-padding-2">
            <div class="resource-title margin-top-1 large-margin-top-0">
                <?php echo $this->pageTitle($item->displayTitle(null, $valueLang), 2); ?>
                <h2 class="label"><?php echo $translate('Item'); ?></h2>
            </div>
            <?php echo $rightSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <?php $this->trigger('view.show.after'); ?>
</div>