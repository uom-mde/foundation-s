<?php
$translate = $this->plugin('translate');
$escape = $this->plugin('escapeHtml');
$this->headLink()->appendStylesheet($this->assetUrl('css/resource-page-blocks.css', 'Omeka'));
$this->htmlElement('body')->appendAttribute('class', 'item resource show');
$embedMedia = $this->siteSetting('item_media_embed', false);
$itemMedia = $item->media();
$showLayout = $this->themeSetting('show_layout');
$mediaDisplay = $this->themeSetting('media_display');
$this->headLink()->appendStylesheet($this->assetUrl('css/resource-page-blocks.css', 'Omeka'));

$fullWidthMainBlockContent = $this->resourcePageBlocks($item, 'full_width_main');
$fullWidthMainHasBlocks = $fullWidthMainBlockContent->hasBlocks();
$mainWithSidebarBlockContent = $this->resourcePageBlocks($item);
$mainWithSidebarHasBlocks= $mainWithSidebarBlockContent->hasBlocks();
$leftSidebarBlockContent = $this->resourcePageBlocks($item, 'left');
$leftSidebarHasBlocks = $leftSidebarBlockContent->hasBlocks();
$rightSidebarBlockContent = $this->resourcePageBlocks($item, 'right');
$rightSidebarHasBlocks = $rightSidebarBlockContent->hasBlocks();

$filterLocale = (bool) $this->siteSetting('filter_locale_values');
$lang = $this->lang();
$valueLang = $filterLocale ? [$lang, ''] : null;
?>

<div class="resource-title">
<?php echo $this->pageTitle($item->displayTitle(null, $valueLang), 2); ?>
<h3 class="label"><?php echo $translate('Item'); ?></h3>
</div>

<div class="<?php echo ($showLayout == 'inline') ? 'inline' : 'stack'; ?>">
    <?php $this->trigger('view.show.before'); ?>
    <?php if ($fullWidthMainHasBlocks): ?>
    <div class="full-width-main">

    <?php foreach ($item->media() as $m): ?>
        <p>
            <strong>Media Type:</strong> <?= $m->mediaType() ?: 'n/a'; ?><br>
            <strong>Renderer:</strong> <?= $m->renderer(); ?><br>
            <strong>Original URL:</strong> <a href="<?= $m->originalUrl(); ?>" target="_blank"><?= $m->originalUrl(); ?></a>
        </p>
    <?php endforeach; ?>

    <?php foreach ($item->media() as $media): ?>
        <div style="margin-bottom: 1em; padding: 0.5em; border: 1px solid #ccc;">
            <strong>Media ID:</strong> <?= $media->id(); ?><br>
            <strong>Media Type:</strong> <?= $media->mediaType() ?: 'N/A'; ?><br>
            <strong>Renderer:</strong> <?= $media->renderer(); ?><br>
            <strong>Original Filename:</strong> <?= $media->source(); ?><br>
            <strong>Original URL:</strong> <a href="<?= $media->originalUrl(); ?>" target="_blank"><?= $media->originalUrl(); ?></a>
        </div>
    <?php endforeach; ?>

    <?php
$excludedRenderers = ['html', 'webvtt', 'iiif'];
$allowedMediaTypes = [];
$hasRenderable = false;

// First pass: collect allowed types and check for non-excluded media
foreach ($item->media() as $media) {
    if (!in_array($media->renderer(), $excludedRenderers)) {
        $allowedMediaTypes[] = $media->mediaType();
        $hasRenderable = true;
    }
}

// De-duplicate media types
$allowedMediaTypes = array_unique($allowedMediaTypes);

// Then call Octopus Viewer for those types only
if ($hasRenderable && !empty($allowedMediaTypes)) {
    echo $this->octopusViewer()->viewer(
        [
            'media_types' => $allowedMediaTypes,
            'item_id' => $item->id(),
        ],
    );
}

// Fallback: render excluded items manually
foreach ($item->media() as $media) {
    if (in_array($media->renderer(), $excludedRenderers)) {
        echo $media->render();
    }
}

?>

        <?php echo $fullWidthMainBlockContent->getBlocks(); ?>
    </div>
    <?php endif; ?>

    <?php if ($mainWithSidebarHasBlocks || $leftSidebarHasBlocks || $rightSidebarHasBlocks): ?>
    
    <?php 
    if ($leftSidebarHasBlocks && $rightSidebarHasBlocks) {
        $sidebarWidth = '3';
        $mainWidth = '6';
    } else {
        $sidebarWidth = '4';
        $mainWidth = '8';
    }
    ?>
    
    <div class="grid-x grid-margin-x">
        <?php if ($leftSidebarHasBlocks): ?>
        <div class="left-sidebar cell medium-<?php echo $sidebarWidth; ?>">
            <?php echo $leftSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>

        <?php if ($mainWithSidebarHasBlocks): ?>
        <div class="main-with-sidebar cell medium-<?php echo $mainWidth; ?>">
            <?php echo $mainWithSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>

        <?php if ($rightSidebarHasBlocks): ?>
        <div class="right-sidebar cell medium-<?php echo $sidebarWidth; ?>">
            <?php echo $rightSidebarBlockContent->getBlocks(); ?>
        </div>
        <?php endif; ?>
    </div>
    <?php endif; ?>

    <?php $this->trigger('view.show.after'); ?>
</div>